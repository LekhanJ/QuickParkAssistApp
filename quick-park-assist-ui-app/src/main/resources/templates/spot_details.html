<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spot Details</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .spot-image {
        max-height: 300px;
        width: 100%;
        object-fit: cover;
        border-radius: 8px;
      }
      .star-rating {
        font-size: 24px;
        cursor: pointer;
      }
      .star-rating .fa-star {
        color: #e0e0e0;
      }
      .star-rating .fa-star.checked {
        color: #ffd700;
      }
      .detail-card {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }
      .detail-card:hover {
        transform: translateY(-5px);
      }
      .price-tag {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
      }
      .badge-ev {
        background-color: #27ae60;
      }
      .badge-vehicle {
        background-color: #3498db;
      }
      .rating-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
      }
      .vehicle-types {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div th:replace="~{fragments/navbar :: navbar}"></div>

      <div class="alert alert-success" th:if="${param.success}" role="alert">
        Action completed successfully!
      </div>
      <div class="alert alert-danger" th:if="${param.error}" role="alert">
        <span th:text="${param.error}">Error message</span>
      </div>

      <div class="row mt-4">
        <div class="col-lg-8 mx-auto">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a th:href="@{/spots/home}">Home</a>
              </li>
              <li class="breadcrumb-item">
                <a th:href="@{/spots/search}">Spots</a>
              </li>
              <li
                class="breadcrumb-item active"
                aria-current="page"
                th:text="${spot.spotNumber}"
              >
                Spot Details
              </li>
            </ol>
          </nav>

          <div class="card detail-card mb-4">
            <div class="row g-0">
              <div class="col-md-6">
                <img
                  th:if="${spot.spotImage != null && !spot.spotImage.isEmpty()}"
                  th:src="${spot.spotImage}"
                  class="spot-image img-fluid"
                  alt="Spot Image"
                />
                <img
                  th:if="${spot.spotImage == null || spot.spotImage.isEmpty()}"
                  src="/img/default-spot.jpg"
                  class="spot-image img-fluid"
                  alt="Default Spot Image"
                />
              </div>
              <div class="col-md-6">
                <div class="card-body">
                  <div
                    class="d-flex justify-content-between align-items-center mb-3"
                  >
                    <h3
                      class="card-title"
                      th:text="${'Spot #' + spot.spotNumber}"
                    >
                      Spot #123
                    </h3>
                    <span
                      class="badge rounded-pill"
                      th:classappend="${spot.status == T(com.qpa.entity.SpotStatus).AVAILABLE ? 'bg-success' : 'bg-danger'}"
                      th:text="${spot.status}"
                      >Status</span
                    >
                  </div>

                  <div class="mb-3">
                    <div class="d-flex align-items-center">
                      <div class="me-2">
                        <i class="fas fa-star text-warning"></i>
                      </div>
                      <span
                        th:text="${spot.averageRating != null ? spot.averageRating + ' / 5' : 'Not rated yet'}"
                        class="fw-bold"
                        >4.5 / 5</span
                      >
                    </div>
                  </div>

                  <p
                    class="price-tag mb-3"
                    th:text="${'₹' + #numbers.formatDecimal(spot.price, 1, 2) + ' ' + #strings.toLowerCase(spot.priceType)}"
                  >
                    ₹50.00 hourly
                  </p>

                  <p class="card-text">
                    <strong>Type:</strong>
                    <span th:text="${spot.spotType}">INDOOR</span>
                  </p>

                  <p class="card-text">
                    <strong>Location:</strong>
                    <span
                      th:text="${spot.location.landmark + ', ' + spot.location.city + ', ' + spot.location.state + ' - ' + spot.location.pincode}"
                    >
                      Landmark, City, State - Pincode
                    </span>
                  </p>

                  <div class="mb-3">
                    <strong>Features:</strong>
                    <div class="mt-2">
                      <span
                        th:if="${spot.hasEVCharging}"
                        class="badge badge-ev me-2 mb-1"
                      >
                        <i class="fas fa-charging-station me-1"></i> EV Charging
                      </span>
                    </div>
                  </div>

                  <div class="mb-3">
                    <strong>Supported Vehicles:</strong>
                    <div class="vehicle-types mt-2">
                      <span
                        th:each="vehicleType : ${spot.supportedVehicleTypes}"
                        class="badge badge-vehicle me-2 mb-1"
                        th:text="${vehicleType}"
                        >Vehicle Type</span
                      >
                    </div>
                  </div>

                  <div class="d-grid gap-2 mt-4">
                    <a
                      th:href="@{/ui/booking/add(spotId=${spot.spotId})}"
                      class="btn btn-primary"
                      th:classappend="${!spot.isActive || spot.status != T(com.qpa.entity.SpotStatus).AVAILABLE ? 'disabled' : ''}"
                    >
                      <i class="fas fa-calendar-check me-2"></i> Book Now
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Rating Section -->
          <div class="card detail-card">
            <div class="card-body">
              <h4 class="card-title mb-4">Rate This Spot</h4>

              <div class="rating-section">
                <p>Your Rating:</p>
                <div class="star-rating mb-3" id="ratingStars">
                  <i class="far fa-star" data-rating="1"></i>
                  <i class="far fa-star" data-rating="2"></i>
                  <i class="far fa-star" data-rating="3"></i>
                  <i class="far fa-star" data-rating="4"></i>
                  <i class="far fa-star" data-rating="5"></i>
                </div>

                <button id="submitRating" class="btn btn-success">
                  <i class="fas fa-paper-plane me-2"></i> Submit Rating
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
              document.addEventListener('DOMContentLoaded', function() {
                  const spotId = [[${spot.spotId}]];
                  const ratingStars = document.querySelectorAll('#ratingStars i');
                  const submitButton = document.getElementById('submitRating');
                  let selectedRating = 0;

                  // Check if user has already rated this spot
                  fetchUserRating();

                  // Add event listeners to stars
                  ratingStars.forEach(star => {
                      // Hover effect
                      star.addEventListener('mouseover', function() {
                          const rating = this.dataset.rating;
                          highlightStars(rating);
                      });

                      star.addEventListener('mouseout', function() {
                          resetStars();
                          if (selectedRating > 0) {
                              highlightStars(selectedRating);
                          }
                      });

                      // Click event
                      star.addEventListener('click', function() {
                          selectedRating = this.dataset.rating;
                          highlightStars(selectedRating);
                      });
                  });

                  // Submit rating
                  submitButton.addEventListener('click', function() {
                      if (selectedRating === 0) {
                          alert('Please select a rating before submitting');
                          return;
                      }

                      const commentElement = document.getElementById('comment');
                      const comment = commentElement ? commentElement.value : '';
                      submitRating(spotId, selectedRating, comment);
                  });

                  function highlightStars(rating) {
                      ratingStars.forEach(star => {
                          if (star.dataset.rating <= rating) {
                              star.classList.remove('far');
                              star.classList.add('fas', 'checked');
                          } else {
                              star.classList.remove('fas', 'checked');
                              star.classList.add('far');
                          }
                      });
                  }

                  function resetStars() {
                      ratingStars.forEach(star => {
                          star.classList.remove('fas', 'checked');
                          star.classList.add('far');
                      });
                  }

                  function fetchUserRating() {
                      fetch(`/spots/api/ratings/${spotId}/user-rating`)
                          .then(response => {
                              if (!response.ok) {
                                  if (response.status === 401) {
                                      // User not logged in or unauthorized
                                      return null;
                                  }
                                  throw new Error('Failed to fetch user rating');
                              }
                              return response.json();
                          })
                          .then(data => {
                              if (data && data.data) {
                                  selectedRating = data.data;
                                  highlightStars(selectedRating);
                              }
                          })
                          .catch(error => {
                              console.error('Error fetching user rating:', error);
                          });
                  }

                  function submitRating(spotId, rating, comment) {
          fetch(`/spots/api/ratings/${spotId}/submit`, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  value: rating,
                  // If you want to keep the comment functionality, you would need to
                  // add a 'comment' field to your RatingRequestDTO
              })
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error('Failed to submit rating');
              }
              return response.json();
          })
          .then(data => {
              if (data.success) {
                  alert('Rating submitted successfully!');
                  // Refresh page to show updated rating
                  window.location.reload();
              } else {
                  alert('Failed to submit rating: ' + data.message);
              }
          })
          .catch(error => {
              console.error('Error submitting rating:', error);
              alert('An error occurred while submitting your rating. Please try again.');
          });
      }
              });
    </script>
  </body>
</html>
